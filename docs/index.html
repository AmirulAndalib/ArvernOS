<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ArvernOS: Introduction</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ArvernOS
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Introduction </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md0"></a>
ArvernOS</h1>
<p ><a href="https://gitter.im/willdurand-kernel/community?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge"><img src="https://badges.gitter.im/willdurand-kernel/community.svg" alt="Gitter" style="pointer-events: none;" class="inline"/></a> <a href="https://circleci.com/gh/willdurand/ArvernOS/tree/master"><img src="https://circleci.com/gh/willdurand/ArvernOS/tree/master.svg?style=svg" alt="CircleCI" style="pointer-events: none;" class="inline"/></a></p>
<p >ArvernOS (formerly known as "willOS") is a minimal and experimental monolithic kernel (not really an Operating System because it cannot do a lot of things currently). Some screencasts are available in <a href="https://twitter.com/couac/status/866693418130575361">this Twitter thread</a>.</p>
<h2><a class="anchor" id="autotoc_md1"></a>
Goals</h2>
<p >The main goal of this project is to learn about operating systems, kernel development, different architectures and improve my C skills. ArvernOS is a monolithic (and hopefully modular) <a class="el" href="md_src_kernel__r_e_a_d_m_e.html">kernel</a> with a unified homemade <a class="el" href="md_src_libc__r_e_a_d_m_e.html">libc/libk</a>, and <a class="el" href="md_src_userland__r_e_a_d_m_e.html">userland</a> programs.</p>
<p >The roadmap isn't clearly defined yet and it mainly depends on what I'd like to work on when I have time to spend on this project.</p>
<h2><a class="anchor" id="autotoc_md2"></a>
Architectures, boards and tiers</h2>
<p >ArvernOS supports the architectures and boards listed below. Support for different architectures and boards are organized into two tiers, each with a different set of guarantees.</p>
<h3><a class="anchor" id="autotoc_md3"></a>
Tier 1</h3>
<p >Tier 1 is the reference implementation and very likely the most advanced.</p>
<p >Current Tier 1 archs/boards:</p>
<ul>
<li><b>x86_64</b><ul>
<li>generic</li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="autotoc_md4"></a>
Tier 2</h3>
<p >Tier 2 is guaranteed to build but not all features have been implemented yet. Features are defined by the reference implementation and once feature parity is achieved, an architecture and/or board should move to Tier 1. Boards for which we cannot run enough tests in CI (e.g., because QEMU does not support the board) should stay in Tier 2, though.</p>
<p >Current Tier 2 archs/boards:</p>
<ul>
<li><b>aarch32</b><ul>
<li><a class="el" href="md_src_kernel_arch_aarch32_board_licheepi_nano__r_e_a_d_m_e.html">Lichee Pi Nano</a></li>
<li><a class="el" href="md_src_kernel_arch_aarch32_board_raspi2__r_e_a_d_m_e.html">Raspberry Pi 2</a></li>
</ul>
</li>
<li><b>aarch64</b><ul>
<li><a class="el" href="md_src_kernel_arch_aarch64_board_raspi3__r_e_a_d_m_e.html">Raspberry Pi 3</a></li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md5"></a>
Hacking on ArvernOS</h2>
<p >This section (and its sub-sections) are written for everyone interested in building and working on ArvernOS.</p>
<h3><a class="anchor" id="autotoc_md6"></a>
Setting up a development environment</h3>
<p >The following dependencies are required to build this project:</p>
<ul>
<li><code>llvm</code> (version 13 currently)</li>
<li><code>make</code></li>
<li><code>qemu</code> (version &gt;= 5)</li>
</ul>
<p >If you want to work on the <code>x86_64</code> architecture, you'll need the following extra dependencies:</p>
<ul>
<li><code>nasm</code></li>
<li><code>grub-mkrescue</code></li>
<li><code>xorriso</code></li>
</ul>
<p >If you want to work on ARM architectures (<code>aarch32</code> or <code>aarch64</code>), you'll need the following extra dependencies:</p>
<ul>
<li><code>gcc-arm-none-eabi</code></li>
<li><code>u-boot-tools</code></li>
</ul>
<dl class="section note"><dt>Note</dt><dd>The recommended way to work on this project is to use Docker.</dd></dl>
<h4><a class="anchor" id="autotoc_md7"></a>
Getting the sources</h4>
<p >This project contains <a href="https://git-scm.com/book/en/v2/Git-Tools-Submodules">git submodules</a>. You have to clone the main project as well as the submodules, either by using this command:</p>
<div class="fragment"><div class="line">$ git clone --recurse-submodules &lt;url pointing to this repo&gt;</div>
</div><!-- fragment --><p >or by using this command if you already have a copy of this git repository:</p>
<div class="fragment"><div class="line">$ git submodule update --init</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md8"></a>
Docker (recommended way)</h4>
<p >Use <a href="https://docs.docker.com/">Docker</a> with the provided <a href="https://github.com/willdurand/ArvernOS/blob/master/Dockerfile"><code>Dockerfile</code></a>. You can either use the <a href="https://hub.docker.com/repository/docker/willdurand/arvernos-toolchain"><code>willdurand/arvernos-toolchain</code> image from DockerHub</a> or build your own:</p>
<div class="fragment"><div class="line">$ docker build -t willdurand/arvernos-toolchain .</div>
<div class="line">[...]</div>
</div><!-- fragment --><p >You can then use it with <code>docker run</code>:</p>
<div class="fragment"><div class="line">$ docker run -it --rm -v $(pwd):/app willdurand/arvernos-toolchain make help</div>
<div class="line">ArvernOS - available commands for arch=x86_64</div>
<div class="line"> </div>
<div class="line">clean                          remove build artifacts</div>
<div class="line">debug                          build the project in debug mode</div>
<div class="line">docs                           build the docs</div>
<div class="line">fmt                            automatically format the code with clang-format</div>
<div class="line">gdb                            build, run the project in debug mode and enable GDB</div>
<div class="line">help                           show this help message</div>
<div class="line">libc                           build the libc</div>
<div class="line">release                        build the project in release mode</div>
<div class="line">run-debug                      run the project in debug mode</div>
<div class="line">run-release                    run the project in release mode</div>
<div class="line">run-test                       run the project in test mode</div>
<div class="line">test                           run the unit tests</div>
<div class="line">userland                       compile the userland programs (statically linked to libc)</div>
<div class="line">version                        print tool versions</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>The output of the <code>make help</code> command may contain different commands depending on the architecture and board configured.</dd></dl>
<h4><a class="anchor" id="autotoc_md9"></a>
MacOS</h4>
<p >Install <a href="https://brew.sh/">Homebrew</a>, then run the following commands:</p>
<div class="fragment"><div class="line">$ brew install nasm xorriso qemu llvm u-boot-tools</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md10"></a>
Linux</h4>
<p >The <code>tools/install-linux-deps</code> script is used to install the dependencies. It is currently used by both the <code>Dockerfile</code> and Circle CI.</p>
<h3><a class="anchor" id="autotoc_md11"></a>
Building ArvernOS</h3>
<p >You first need to install the development dependencies in order to build ArvernOS. The different final files are located in the <code>build/&lt;arch&gt;/dist/</code> or <code>build/&lt;arch&gt;/&lt;board&gt;/dist/</code> folder.</p>
<h4><a class="anchor" id="autotoc_md12"></a>
Debug mode</h4>
<p >To build the image in debug mode, run:</p>
<div class="fragment"><div class="line">$ make clean ; make debug</div>
</div><!-- fragment --><p >To compile the OS in debug mode, build the image, and start <code>qemu</code> with the OS loaded, run:</p>
<div class="fragment"><div class="line">$ make clean ; make run-debug</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Some boards aren't supported in QEMU.</dd></dl>
<p><a class="anchor" id="autotoc_md13"></a> </p><h5>QEMU monitor</h5>
<p >When running <code>make run-debug</code>, the <a href="https://www.qemu.org/docs/master/system/monitor.html">QEMU monitor</a> can be accessed over TCP on port <code>5555</code>. You can use tools like <code>telnet</code> or <code>nc</code>:</p>
<div class="fragment"><div class="line">$ telnet 127.0.0.1 5555</div>
</div><!-- fragment --><p ><a class="anchor" id="autotoc_md14"></a> </p><h5>Logging</h5>
<p >In debug mode, logging very likely uses the serial port <code>COM1</code> to write various debugging information. QEMU is configured to write the output of this serial port to a logfile in <code>./log/</code>. <code>DEBUG</code> level logs are not necessarily written by default, though, and it is possible to enable <code>DEBUG</code> logs for specific modules like this:</p>
<div class="fragment"><div class="line"># Enable the debug logs for the &quot;net&quot; and &quot;fs&quot; modules</div>
<div class="line">$ make clean ; make run-debug ENABLE_NET_DEBUG=1 ENABLE_FS_DEBUG=1</div>
</div><!-- fragment --><p >The available debug variables are:</p>
<ul>
<li><code>ENABLE_CONFIG_DEBUG</code></li>
<li><code>ENABLE_CORE_DEBUG</code></li>
<li><code>ENABLE_FS_DEBUG</code></li>
<li><code>ENABLE_MMU_DEBUG</code></li>
<li><code>ENABLE_NET_DEBUG</code></li>
<li><code>ENABLE_PROC_DEBUG</code></li>
<li><code>ENABLE_SYS_DEBUG</code></li>
<li><code>ENABLE_USERLAND_DEBUG</code></li>
</ul>
<p ><a class="anchor" id="autotoc_md15"></a> </p><h5>Stack traces</h5>
<p >Log files may contain stack traces without debug symbols if the symbols haven't been loaded:</p>
<div class="fragment"><div class="line">[...]</div>
<div class="line">DEBUG    | src/kernel/arch/x86_64/kshell/kshell.c:108:run_command(): command=&#39;selftest&#39; argc=1</div>
<div class="line">DEBUG    | src/kernel/arch/x86_64/kernel/panic.c:30:kernel_dump_stacktrace(): kernel stacktrace:</div>
<div class="line">DEBUG    | src/kernel/arch/x86_64/kernel/panic.c:39:kernel_dump_stacktrace(): 00000000001163B3 - ???+0x0</div>
<div class="line">DEBUG    | src/kernel/arch/x86_64/kernel/panic.c:39:kernel_dump_stacktrace(): 0000000000115941 - ???+0x0</div>
<div class="line">DEBUG    | src/kernel/arch/x86_64/kernel/panic.c:39:kernel_dump_stacktrace(): 0000000000115BE1 - ???+0x0</div>
<div class="line">DEBUG    | src/kernel/arch/x86_64/kernel/panic.c:39:kernel_dump_stacktrace(): 00000000001152BF - ???+0x0</div>
<div class="line">DEBUG    | src/kernel/arch/x86_64/kernel/panic.c:39:kernel_dump_stacktrace(): 000000000010935B - ???+0x0</div>
</div><!-- fragment --><p >Use the <code>tools/fix-stacktrace.py</code> script to add missing symbol names to the output:</p>
<div class="fragment"><div class="line">$ ./tools/fix-stacktrace.py build/x86_64/dist/symbols.txt log/x86_64-debug.log</div>
<div class="line">[...]</div>
<div class="line">DEBUG    | src/kernel/arch/x86_64/kshell/kshell.c:108:run_command(): command=&#39;selftest&#39; argc=1</div>
<div class="line">DEBUG    | src/kernel/arch/x86_64/kernel/panic.c:30:kernel_dump_stacktrace(): kernel stacktrace:</div>
<div class="line">DEBUG    | src/kernel/arch/x86_64/kernel/panic.c:39:kernel_dump_stacktrace():   00000000001163B3 - selftest+0x63</div>
<div class="line">DEBUG    | src/kernel/arch/x86_64/kernel/panic.c:39:kernel_dump_stacktrace():   0000000000115941 - run_command+0x271</div>
<div class="line">DEBUG    | src/kernel/arch/x86_64/kernel/panic.c:39:kernel_dump_stacktrace():   0000000000115BE1 - kshell_run+0x181</div>
<div class="line">DEBUG    | src/kernel/arch/x86_64/kernel/panic.c:39:kernel_dump_stacktrace():   00000000001152BF - kmain+0x107f</div>
<div class="line">DEBUG    | src/kernel/arch/x86_64/kernel/panic.c:39:kernel_dump_stacktrace():   000000000010935B - long_mode_start+0x13</div>
</div><!-- fragment --><p >In addition, you might want to find the corresponding line of code in the source files by using <code>llvm-addr2line</code> or <code>llvm-symbolizer</code>:</p>
<div class="fragment"><div class="line">$ llvm-symbolizer-13 --obj=build/x86_64/dist/kernel-x86_64.bin 0x01163B3</div>
<div class="line">print_selftest_header</div>
<div class="line">/path/to/ArvernOS/src/kernel/kshell/selftest.c:12:3</div>
<div class="line">selftest</div>
<div class="line">/path/to/ArvernOS/src/kernel/kshell/selftest.c:30:3</div>
</div><!-- fragment --><div class="fragment"><div class="line">$ llvm-addr2line-13 -e build/x86_64/dist/kernel-x86_64.bin 01163B3</div>
<div class="line">/path/to/ArvernOS/src/kernel/kshell/selftest.c:12</div>
</div><!-- fragment --><p ><a class="anchor" id="autotoc_md16"></a> </p><h5>Debugging</h5>
<p >Use <code>make gdb</code> to run the project in debug mode with QEMU configured to wait for <a href="https://www.sourceware.org/gdb/">gdb</a> to connect. This has been tested with <code>vim</code> (<code>:Termdebug</code>) and VS Code.</p>
<p >A sensible configuration is automatically generated when this command is executed (see also: <code>make gdbinit</code>). If a file named <code>.gdbinit.local</code> exists in the project's root directory, its content will be appended to the generated <code>.gdbinit</code> file.</p>
<dl class="section note"><dt>Note</dt><dd><code>make gdb</code> calls <code>make run-debug</code> under the hood so all configuration options are also supported. For example, it is possible to run <code>make gdb KERNEL_CMDLINE="kshell selftest"</code>.</dd></dl>
<h4><a class="anchor" id="autotoc_md17"></a>
Release mode</h4>
<p >To compile the OS in release mode, build the image, and start <code>qemu</code> with the OS loaded, run:</p>
<div class="fragment"><div class="line">$ make clean ; make run-release</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md18"></a>
config files</h4>
<p ><code>config</code> files are used to configure how a build works. The content must be compatible with <code>make</code>. Here is an example:</p>
<div class="fragment"><div class="line"># LLVM config on MacOS with Homebrew</div>
<div class="line">LLVM_PREFIX = /usr/local/opt/llvm@13/bin/</div>
<div class="line">LLVM_SUFFIX =</div>
<div class="line"> </div>
<div class="line"># Always enable the Undefined Behavior sanitizer</div>
<div class="line">UBSAN = 1</div>
<div class="line"> </div>
<div class="line"># Logging</div>
<div class="line">ENABLE_CORE_DEBUG     = 1</div>
<div class="line">ENABLE_PROC_DEBUG     = 1</div>
<div class="line">ENABLE_SYS_DEBUG      = 1</div>
<div class="line">ENABLE_USERLAND_DEBUG = 1</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md19"></a>
License</h2>
<p >ArvernOS is released under the MIT License. See the bundled <a href="https://github.com/willdurand/ArvernOS/blob/master/LICENSE.md">LICENSE</a> file for details. In addition, some parts of this project have their own licenses attached (either in the source files or in a <code>LICENSE</code> file next to them). </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
